<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en-GB">
<head th:replace="~{fragments/template :: head('Record Details')}" />
<body class="bg-light d-flex flex-column min-vh-100">
    <header th:replace="~{fragments/template :: header}"></header>
    
    <main class="container py-4 flex-grow-1">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-eye me-2"></i>
                Record Details
            </h1>
            <div class="btn-group">
                <a href="#" th:href="@{'/evaluations?runId=' + ${record.runId}}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to List
                </a>
                <button class="btn btn-warning" onclick="showScoreModal()">
                    <i class="fas fa-edit me-1"></i>Update Score
                </button>
            </div>
        </div>
        
        <!-- Alerts -->
        <div th:replace="~{fragments/template :: alerts}"></div>
        
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Input Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-keyboard me-2"></i>Input
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="border p-3 bg-light rounded" style="white-space: pre-wrap;" th:text="${record.input}">
                            Input content will be displayed here...
                        </div>
                    </div>
                </div>
                
                <!-- Response Section -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-reply me-2"></i>Response
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="border p-3 bg-light rounded" style="white-space: pre-wrap;" th:text="${record.response}">
                            Response content will be displayed here...
                        </div>
                    </div>
                </div>
                
                <!-- LLM Evaluation -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-robot me-2"></i>LLM Evaluation
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Score:</strong>
                                <span th:class="${record.llmScore?.badgeClass} + ' ms-2'" th:text="${record.llmScore?.displayValue}">Score</span>
                            </div>
                            <div class="col-md-9">
                                <strong>Reasoning:</strong>
                                <div class="mt-2 p-3 bg-light border rounded" style="white-space: pre-wrap;" th:text="${record.llmReason}">
                                    LLM reasoning will be displayed here...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Human Evaluation -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-check me-2"></i>Human Evaluation
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Score:</strong>
                                <span th:class="${record.humanScore?.badgeClass} + ' ms-2'" th:text="${record.humanScore?.displayValue}">Score</span>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-warning" onclick="showScoreModal()">
                                        <i class="fas fa-edit me-1"></i>Edit Score
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-9">
                                <strong>Reasoning:</strong>
                                <div class="mt-2 p-3 bg-light border rounded" style="white-space: pre-wrap;" 
                                     th:text="${record.humanReason ?: 'No human reasoning provided yet.'}">
                                    Human reasoning will be displayed here...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Metadata Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Metadata
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <small class="text-muted">Record ID</small>
                                <div class="fw-bold small" th:text="${record.id}">ID</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Run ID</small>
                                <div class="fw-bold small" th:text="${record.runId}">Run ID</div>
                            </div>
                            <div class="col-12">
                                <small class="text-muted">Timestamp</small>
                                <div class="fw-bold" th:text="${#temporals.format(record.timestamp, 'yyyy-MM-dd HH:mm:ss')}">
                                    Timestamp
                                </div>
                            </div>
                            <div th:if="${record.metadata}" class="col-12">
                                <small class="text-muted">Processing Time</small>
                                <div class="fw-bold" th:if="${record.metadata.processingTimeMs}">
                                    <span th:text="${record.metadata.processingTimeMs}">0</span>ms
                                </div>
                                <div th:unless="${record.metadata.processingTimeMs}" class="text-muted">
                                    Not available
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Model Information -->
                <div class="card mb-4" th:if="${record.metadata}">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-cog me-2"></i>Model Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12" th:if="${record.metadata.model}">
                                <small class="text-muted">Model</small>
                                <div class="fw-bold" th:text="${record.metadata.model}">Model Name</div>
                            </div>
                            <div class="col-6" th:if="${record.metadata.temperature}">
                                <small class="text-muted">Temperature</small>
                                <div class="fw-bold" th:text="${record.metadata.temperature}">0.7</div>
                            </div>
                            <div class="col-6" th:if="${record.metadata.maxTokens}">
                                <small class="text-muted">Max Tokens</small>
                                <div class="fw-bold" th:text="${record.metadata.maxTokens}">1000</div>
                            </div>
                        </div>
                        <div th:unless="${record.metadata.model or record.metadata.temperature or record.metadata.maxTokens}" 
                             class="text-muted">
                            No model information available
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-tools me-2"></i>Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning" onclick="showScoreModal()">
                                <i class="fas fa-edit me-2"></i>Update Human Score
                            </button>
                            <a href="#" th:href="@{'/evaluations?runId=' + ${record.runId}}" class="btn btn-outline-secondary">
                                <i class="fas fa-list me-2"></i>View All Records
                            </a>
                            <button class="btn btn-outline-danger" onclick="confirmDelete()">
                                <i class="fas fa-trash me-2"></i>Delete Record
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Human Score Modal -->
    <div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scoreModalLabel">Update Human Score</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form th:action="@{'/evaluations/' + ${record.id} + '/human-score'}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="scoreSelect" class="form-label">Score:</label>
                            <select id="scoreSelect" name="score" class="form-select" required th:value="${record.humanScore?.displayValue}">
                                <option value="">Select Score</option>
                                <option value="Good" th:selected="${record.humanScore?.displayValue == 'Good'}">Good</option>
                                <option value="Bad" th:selected="${record.humanScore?.displayValue == 'Bad'}">Bad</option>
                                <option value="Unknown" th:selected="${record.humanScore?.displayValue == 'Unknown'}">Unknown</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reasonText" class="form-label">Reason:</label>
                            <textarea id="reasonText" name="reason" class="form-control" rows="4" 
                                      placeholder="Explain your scoring decision..." th:text="${record.humanReason}"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Score</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <footer th:replace="~{fragments/template :: footer}"></footer>
    <div th:replace="~{fragments/template :: scripts}"></div>
    
    <script>
        function showScoreModal() {
            new bootstrap.Modal(document.getElementById('scoreModal')).show();
        }
        
        function confirmDelete() {
            if (confirm('Are you sure you want to delete this evaluation record?')) {
                // Create form for DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/evaluations/' + /*[[${record.id}]]*/ '';
                
                const methodInput = document.createElement('input');
                methodInput.type = 'hidden';
                methodInput.name = '_method';
                methodInput.value = 'DELETE';
                form.appendChild(methodInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>
