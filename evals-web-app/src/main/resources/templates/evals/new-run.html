<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en-GB">
<head th:replace="~{fragments/template :: head('Create New Run')}" />
<body class="bg-light d-flex flex-column min-vh-100">
    <header th:replace="~{fragments/template :: header}"></header>
    
    <main class="container py-4 flex-grow-1">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title mb-0">
                            <i class="fas fa-plus-circle me-2"></i>
                            Create New Evaluation Run
                        </h2>
                    </div>
                    <div class="card-body">
                        <!-- Alerts -->
                        <div th:replace="~{fragments/template :: alerts}"></div>
                        
                        <!-- Service Status Info -->
                        <div class="alert alert-info" th:if="${availableQuestions > 0}">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Ready to create run:</strong> 
                            <span th:text="${availableQuestions}">0</span> questions available from input file.
                        </div>
                        
                        <div class="alert alert-warning" th:if="${availableQuestions == 0}">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>No questions found:</strong> 
                            Please ensure the input questions file is available in src/main/data/input-questions.json
                        </div>
                        
                        <form th:action="@{/runs/new}" method="post" th:object="${run}">
                            <!-- Basic Information -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <h5 class="text-primary">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Basic Information
                                    </h5>
                                    <hr>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label">Run Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" th:field="*{name}" 
                                           placeholder="e.g., GPT-4 Baseline Test" required>
                                    <div class="form-text">Give your evaluation run a descriptive name</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" th:field="*{status}">
                                        <option value="CREATED">Created</option>
                                        <option value="RUNNING">Running</option>
                                        <option value="COMPLETED">Completed</option>
                                        <option value="FAILED">Failed</option>
                                        <option value="CANCELLED">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" th:field="*{description}" 
                                              rows="3" placeholder="Describe the purpose and scope of this evaluation run..."></textarea>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="totalRecords" class="form-label">Total Records</label>
                                    <input type="number" class="form-control" id="totalRecords" th:field="*{totalRecords}" 
                                           min="0" th:value="${availableQuestions}" readonly>
                                    <div class="form-text">Will be set automatically from input questions file (<span th:text="${availableQuestions}">0</span> questions)</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="completedRecords" class="form-label">Completed Records</label>
                                    <input type="number" class="form-control" id="completedRecords" th:field="*{completedRecords}" 
                                           min="0" value="0" readonly>
                                    <div class="form-text">Will be updated during execution</div>
                                </div>
                            </div>
                            
                            <!-- Configuration Section -->
                            <div class="row mb-4 mt-5">
                                <div class="col-12">
                                    <h5 class="text-primary">
                                        <i class="fas fa-cogs me-2"></i>
                                        Configuration
                                    </h5>
                                    <hr>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="modelName" class="form-label">Model Name</label>
                                    <select class="form-select" id="modelName" th:field="${configuration.modelName}">
                                        <option value="">Select a model</option>
                                        <option value="gpt-4-turbo-preview">GPT-4 Turbo Preview</option>
                                        <option value="gpt-4">GPT-4</option>
                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                        <option value="claude-3-opus">Claude 3 Opus</option>
                                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                                        <option value="claude-3-haiku">Claude 3 Haiku</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="outputFormat" class="form-label">Output Format</label>
                                    <select class="form-select" id="outputFormat" th:field="${configuration.outputFormat}">
                                        <option value="json">JSON</option>
                                        <option value="csv">CSV</option>
                                        <option value="xml">XML</option>
                                        <option value="text">Plain Text</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="temperature" class="form-label">Temperature</label>
                                    <input type="number" class="form-control" id="temperature" th:field="${configuration.temperature}" 
                                           step="0.1" min="0" max="2" value="0.7">
                                    <div class="form-text">0.0 = deterministic, 2.0 = very random</div>
                                </div>
                                <div class="col-md-4">
                                    <label for="maxTokens" class="form-label">Max Tokens</label>
                                    <input type="number" class="form-control" id="maxTokens" th:field="${configuration.maxTokens}" 
                                           min="1" max="4096" value="1000">
                                </div>
                                <div class="col-md-4">
                                    <label for="batchSize" class="form-label">Batch Size</label>
                                    <input type="number" class="form-control" id="batchSize" th:field="${configuration.batchSize}" 
                                           min="1" max="100" value="10">
                                    <div class="form-text">Number of requests to process at once</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-12">
                                    <label for="inputDataSource" class="form-label">Input Data Source</label>
                                    <input type="text" class="form-control" id="inputDataSource" th:field="${configuration.inputDataSource}" 
                                           placeholder="e.g., /path/to/input/data.json or dataset-name">
                                    <div class="form-text">Path to input data file or dataset identifier</div>
                                </div>
                            </div>
                            
                            <div class="row mb-4">
                                <div class="col-12">
                                    <label for="evaluationPrompt" class="form-label">Evaluation Prompt</label>
                                    <textarea class="form-control" id="evaluationPrompt" th:field="${configuration.evaluationPrompt}" 
                                              rows="4" placeholder="Enter the system prompt for evaluation...">You are an expert evaluator. Assess the quality of the AI response based on accuracy, helpfulness, and clarity. Provide a score (Good/Bad) and detailed reasoning.</textarea>
                                    <div class="form-text">System prompt used for AI evaluation</div>
                                </div>
                            </div>
                            
                            
                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-between">
                                <a href="#" th:href="@{/runs}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-success" th:disabled="${availableQuestions == 0}">
                                    <i class="fas fa-save me-1"></i>Create Run
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Help Card -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-question-circle me-2"></i>
                            Quick Tips
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Run Configuration:</h6>
                                <ul class="small text-muted">
                                    <li><strong>Temperature:</strong> Controls randomness (0=deterministic, 1=balanced, 2=creative)</li>
                                    <li><strong>Max Tokens:</strong> Maximum response length from the model</li>
                                    <li><strong>Batch Size:</strong> Number of requests to process simultaneously</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Best Practices:</h6>
                                <ul class="small text-muted">
                                    <li>Use descriptive run names for easy identification</li>
                                    <li>Start with smaller batch sizes for testing</li>
                                    <li>Include clear evaluation criteria in your prompt</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer th:replace="~{fragments/template :: footer}"></footer>
    <div th:replace="~{fragments/template :: scripts}"></div>
    
    <script>
        // Form validation and enhancements
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-update completion percentage when values change
            const totalInput = document.getElementById('totalRecords');
            const completedInput = document.getElementById('completedRecords');
            
            function updateCompletionDisplay() {
                const total = parseInt(totalInput.value) || 0;
                const completed = parseInt(completedInput.value) || 0;
                
                if (total > 0) {
                    const percentage = Math.round((completed / total) * 100);
                    // Could display percentage somewhere if needed
                }
                
                // Ensure completed doesn't exceed total
                if (completed > total) {
                    completedInput.value = total;
                }
            }
            
            totalInput.addEventListener('change', updateCompletionDisplay);
            completedInput.addEventListener('change', updateCompletionDisplay);
            
            // Temperature slider visual feedback
            const tempInput = document.getElementById('temperature');
            tempInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                let description = '';
                if (value <= 0.3) description = 'Very Conservative';
                else if (value <= 0.7) description = 'Balanced';
                else if (value <= 1.2) description = 'Creative';
                else description = 'Very Creative';
                
                // Update help text if desired
                this.nextElementSibling.textContent = `${description} (${value})`;
            });
            
// Form now submits normally via standard HTML form submission
        });
    </script>
</body>
</html>
