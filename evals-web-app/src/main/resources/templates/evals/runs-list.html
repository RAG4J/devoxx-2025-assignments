<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en-GB">
<head th:replace="~{fragments/template :: head('Evaluation Runs')}" />
<body class="bg-light d-flex flex-column min-vh-100">
    <header th:replace="~{fragments/template :: header}"></header>
    
    <main class="container py-4 flex-grow-1">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-list-alt me-2"></i>
                Evaluation Runs
            </h1>
            <a href="#" th:href="@{/runs/new}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i>Create New Run
            </a>
        </div>
        
        <!-- Alerts -->
        <div th:replace="~{fragments/template :: alerts}"></div>
        
        <!-- Runs Grid -->
        <div th:if="${#lists.isEmpty(runs)}" class="text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No evaluation runs found</h4>
            <p class="text-muted">Create your first evaluation run to get started</p>
            <a href="#" th:href="@{/runs/new}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Create Run
            </a>
        </div>
        
        <div th:if="${not #lists.isEmpty(runs)}" class="row g-4">
            <div th:each="run : ${runs}" class="col-lg-4 col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0" th:text="${run.name}">Run Name</h6>
                        <span th:class="${run.statusBadgeClass}" th:text="${run.status}">Status</span>
                    </div>
                    <div class="card-body">
                        <p class="card-text text-muted small" th:text="${run.description}">Run description</p>
                        
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <div class="h4 mb-0 text-primary" th:text="${run.totalRecords}">0</div>
                                    <small class="text-muted">Total</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="h4 mb-0 text-success" th:text="${run.completedRecords}">0</div>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">Progress</small>
                                <small class="text-muted" th:text="${#numbers.formatDecimal(run.completionPercentage, 1, 1)} + '%'">0.0%</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" 
                                     th:style="'width: ' + ${run.completionPercentage} + '%'">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                Created: <span th:text="${#temporals.format(run.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                            </small>
                        </div>
                        
                        <div th:if="${run.configuration}" class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-cog me-1"></i>
                                Model: <span th:text="${run.configuration.modelName ?: 'Not specified'}">Model</span>
                            </small>
                        </div>
                        
                        <!-- Accuracy Information -->
                        <div class="mt-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted d-block">Human Score Accuracy:</small>
                                    <span th:class="${run.humanAccuracyBadgeClass}" th:text="${run.formattedHumanScoreAccuracy}">N/A</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted d-block">LLM Rating Accuracy:</small>
                                    <span th:class="${run.llmAccuracyBadgeClass}" th:text="${run.formattedLlmRatingAccuracy}">N/A</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="btn-group w-100" role="group">
                            <a th:href="@{'/evaluations?runId=' + ${run.id}}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-table me-1"></i>Records
                            </a>
                            <a th:href="@{'/runs/' + ${run.id}}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-eye me-1"></i>View
                            </a>
                            <button class="btn btn-outline-secondary btn-sm" 
                                    onclick="showActionMenu(this)"
                                    th:attr="data-run-id=${run.id}">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Action Menu Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Run Actions</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-2">
                    <div class="list-group list-group-flush">
                        <a href="#" id="editRunLink" class="list-group-item list-group-item-action">
                            <i class="fas fa-edit me-2 text-warning"></i>Edit Run
                        </a>
                        <a href="#" id="viewRecordsLink" class="list-group-item list-group-item-action">
                            <i class="fas fa-table me-2 text-primary"></i>View Records
                        </a>
                        <button type="button" class="list-group-item list-group-item-action text-success" 
                                onclick="executeRun()">
                            <i class="fas fa-play me-2"></i>Execute Run
                        </button>
                        <button type="button" class="list-group-item list-group-item-action text-danger" 
                                onclick="confirmDeleteRun()">
                            <i class="fas fa-trash me-2"></i>Delete Run
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer th:replace="~{fragments/template :: footer}"></footer>
    <div th:replace="~{fragments/template :: scripts}"></div>
    
    <script>
        let currentRunId = null;
        
        function showActionMenu(button) {
            currentRunId = button.getAttribute('data-run-id');
            
            // Update modal links
            document.getElementById('editRunLink').href = `/runs/${currentRunId}/edit`;
            document.getElementById('viewRecordsLink').href = `/evaluations?runId=${currentRunId}`;
            
            // Show modal
            new bootstrap.Modal(document.getElementById('actionModal')).show();
        }
        
        function confirmDeleteRun() {
            if (currentRunId && confirm('Are you sure you want to delete this evaluation run? This will also delete all associated records.')) {
                // Create form for DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/runs/${currentRunId}`;
                
                const methodInput = document.createElement('input');
                methodInput.type = 'hidden';
                methodInput.name = '_method';
                methodInput.value = 'DELETE';
                form.appendChild(methodInput);
                
                document.body.appendChild(form);
                form.submit();
            }
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
        }
        
        // Handle execute run with progress tracking
        function executeRun() {
            if (currentRunId && confirm('Execute this run? This will start generating agent responses for all questions.')) {
                // Close modal first
                bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
                
                // Use the global progress tracking function
                executeRunWithProgress(currentRunId, `/runs/${currentRunId}/execute`);
            } else {
                // Close modal if user cancels
                bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
            }
        }
        
    </script>
</body>
</html>
