<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en-GB">
<head th:replace="~{fragments/template :: head('Evaluation Records')}" />
<body class="bg-light d-flex flex-column min-vh-100">
    <header th:replace="~{fragments/template :: header}"></header>
    
    <main class="container-fluid py-4 flex-grow-1">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-table me-2"></i>
                Evaluation Records
                <span th:if="${selectedRun}" class="badge bg-secondary ms-2" th:text="${selectedRun.name}"></span>
            </h1>
            
            <div class="d-flex gap-2">
                <a href="#" th:href="@{/runs/new}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>New Run
                </a>
                <a th:if="${selectedRun}" th:href="@{'/runs/' + ${selectedRun.id}}" class="btn btn-info">
                    <i class="fas fa-eye me-1"></i>View Run
                </a>
                <a href="#" th:href="@{/runs}" class="btn btn-outline-primary">
                    <i class="fas fa-list me-1"></i>All Runs
                </a>
            </div>
        </div>
        
        <!-- Alerts -->
        <div th:replace="~{fragments/template :: alerts}"></div>
        
        <!-- Run Filter -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-6">
                        <label for="runFilter" class="form-label">Filter by Run:</label>
                        <select id="runFilter" class="form-select">
                            <option value="">All Runs</option>
                            <option th:each="run : ${runs}" 
                                    th:value="${run.id}" 
                                    th:text="${run.name}"
                                    th:selected="${run.id == selectedRunId}">Run Name</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end">
                            <div class="text-muted">
                                <small>
                                    Showing <strong th:text="${#lists.size(records)}">0</strong> records
                                    <span th:if="${selectedRun}">
                                        from run "<span th:text="${selectedRun.name}"></span>"
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Records Table -->
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col" style="width: 15%;">Input</th>
                                <th scope="col" style="width: 15%;">Response</th>
                                <th scope="col" style="width: 10%;">LLM Score</th>
                                <th scope="col" style="width: 15%;">LLM Reason</th>
                                <th scope="col" style="width: 10%;">Human Score</th>
                                <th scope="col" style="width: 15%;">Human Reason</th>
                                <th scope="col" style="width: 10%;">Timestamp</th>
                                <th scope="col" style="width: 10%;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(records)}">
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                    No evaluation records found
                                    <br><small>Create a new run to get started</small>
                                </td>
                            </tr>
                            <tr th:each="record : ${records}">
                                <!-- Input -->
                                <td>
                                    <div class="text-truncate-custom" th:text="${record.shortInput}"></div>
                                    <button class="btn btn-sm btn-outline-info mt-1" 
                                            onclick="showDetailModal('Input', this)"
                                            th:attr="data-record-id=${record.id}, data-field='input'">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </td>
                                
                                <!-- Response -->
                                <td>
                                    <div class="text-truncate-custom" th:text="${record.shortResponse}"></div>
                                    <button class="btn btn-sm btn-outline-info mt-1" 
                                            onclick="showDetailModal('Response', this)"
                                            th:attr="data-record-id=${record.id}, data-field='response'">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </td>
                                
                                <!-- LLM Score -->
                                <td>
                                    <span th:class="${record.llmScore?.badgeClass}" th:text="${record.llmScore?.displayValue}"></span>
                                </td>
                                
                                <!-- LLM Reason -->
                                <td>
                                    <div class="text-truncate-custom" th:text="${record.shortLlmReason}"></div>
                                    <button class="btn btn-sm btn-outline-info mt-1" 
                                            onclick="showDetailModal('LLM Reason', this)"
                                            th:attr="data-record-id=${record.id}, data-field='llmReason'">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </td>
                                
                                <!-- Human Score -->
                                <td>
                                    <span th:class="${record.humanScore?.badgeClass}" th:text="${record.humanScore?.displayValue}"></span>
                                    <button class="btn btn-sm btn-warning mt-1" 
                                            onclick="showScoreModal(this)"
                                            th:attr="data-record-id=${record.id}">
                                        <i class="fas fa-edit"></i> Score
                                    </button>
                                </td>
                                
                                <!-- Human Reason -->
                                <td>
                                    <div class="text-truncate-custom" th:text="${record.shortHumanReason}"></div>
                                    <button class="btn btn-sm btn-outline-info mt-1" 
                                            onclick="showDetailModal('Human Reason', this)"
                                            th:attr="data-record-id=${record.id}, data-field='humanReason'">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </td>
                                
                                <!-- Timestamp -->
                                <td class="text-nowrap">
                                    <small th:text="${#temporals.format(record.timestamp, 'yyyy-MM-dd HH:mm')}"></small>
                                </td>
                                
                                <!-- Actions -->
                                <td>
                                    <div class="btn-group" role="group">
                                        <a th:href="@{'/evaluations/' + ${record.id} + '/detail'}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="confirmDelete(this)"
                                                th:attr="data-record-id=${record.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalLabel">Field Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="detailContent" style="white-space: pre-wrap; word-wrap: break-word;">
                        Loading...
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Human Score Modal -->
    <div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scoreModalLabel">Update Human Score</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="scoreForm" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="scoreSelect" class="form-label">Score:</label>
                            <select id="scoreSelect" name="score" class="form-select" required>
                                <option value="">Select Score</option>
                                <option value="Good">Good</option>
                                <option value="Bad">Bad</option>
                                <option value="Unknown">Unknown</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="reasonText" class="form-label">Reason:</label>
                            <textarea id="reasonText" name="reason" class="form-control" rows="4" 
                                      placeholder="Explain your scoring decision..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Score</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <footer th:replace="~{fragments/template :: footer}"></footer>
    <div th:replace="~{fragments/template :: scripts}"></div>
    
    <script>
        // Run filter functionality
        document.getElementById('runFilter').addEventListener('change', function() {
            const selectedRunId = this.value;
            if (selectedRunId) {
                window.location.href = '/evaluations?runId=' + selectedRunId;
            } else {
                window.location.href = '/evaluations';
            }
        });
        
        // Detail modal functionality
        function showDetailModal(fieldName, button) {
            const recordId = button.getAttribute('data-record-id');
            const field = button.getAttribute('data-field');
            
            document.getElementById('detailModalLabel').textContent = fieldName + ' Details';
            document.getElementById('detailContent').textContent = 'Loading...';
            
            fetch(`/evaluations/${recordId}/field/${field}`)
                .then(response => response.text())
                .then(content => {
                    document.getElementById('detailContent').textContent = content || 'No content available';
                })
                .catch(error => {
                    document.getElementById('detailContent').textContent = 'Error loading content';
                    console.error('Error:', error);
                });
            
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }
        
        // Score modal functionality
        function showScoreModal(button) {
            const recordId = button.getAttribute('data-record-id');
            const form = document.getElementById('scoreForm');
            form.action = `/evaluations/${recordId}/human-score`;
            
            // Reset form
            document.getElementById('scoreSelect').value = '';
            document.getElementById('reasonText').value = '';
            
            new bootstrap.Modal(document.getElementById('scoreModal')).show();
        }
        
        // Delete confirmation
        function confirmDelete(button) {
            const recordId = button.getAttribute('data-record-id');
            if (confirm('Are you sure you want to delete this evaluation record?')) {
                // Create a form to submit DELETE request
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/evaluations/${recordId}`;
                
                const methodInput = document.createElement('input');
                methodInput.type = 'hidden';
                methodInput.name = '_method';
                methodInput.value = 'DELETE';
                form.appendChild(methodInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
    </script>
</body>
</html>
